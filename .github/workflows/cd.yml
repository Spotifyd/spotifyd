name: Continuous Deployment

on:
  push:
    branches:
      - master
    tags:
      - 'v*.*.*'

jobs:
  build:
    name: Building ${{matrix.os}}-${{ matrix.arch }} (${{ matrix.artifact_type }})
    runs-on: ${{ matrix.runs_on }}
    strategy:
      matrix:
        os: [macos, linux]
        arch: [x86_64, aarch64, armv7]
        rust: [stable]
        artifact_type: ['slim', 'default', 'full']  # The build strategy will build all types for each OS specified
        include:
          # Runner configuration
          - os: macos
            arch: x86_64
            runs_on: macos-15-intel
          - os: macos
            arch: aarch64
            runs_on: macos-15
          - os: linux
            runs_on: ubuntu-22.04
          # DBus configuration
          - artifact_type: slim
            dbus: ''
          - artifact_type: default
            dbus: dbus_mpris
          - artifact_type: full
            dbus: dbus_mpris
          # Cross Compilation Targets
          - os: linux
            arch: aarch64
            target: aarch64-unknown-linux-gnu
          - os: linux
            arch: armv7
            target: armv7-unknown-linux-gnueabihf
          # Audio backend configuration: Linux
          - os: linux
            artifact_type: slim
            audio_backends: alsa_backend
          - os: linux
            artifact_type: default
            audio_backends: alsa_backend,pulseaudio_backend,rodio_backend
          - os: linux
            artifact_type: full
            audio_backends: alsa_backend,pulseaudio_backend,rodio_backend,rodiojack_backend
          # Audio backend configuration: macOS
          - os: macos
            audio_backends: portaudio_backend,rodio_backend
        exclude:
          - os: macos
            artifact_type: 'full'
          - os: macos
            arch: armv7
    steps:
      - name: Checking out sources
        uses: actions/checkout@v4
      - name: Installing needed macOS dependencies
        if: matrix.os == 'macos'
        run: brew install dbus portaudio
      - name: Installing needed Ubuntu dependencies
        if: startsWith(matrix.runs_on, 'ubuntu') && matrix.target == ''
        run: |
          sudo apt-get update
          # WORKAROUND: fix aws-lc-sys compiler bug failure
          sudo apt-get remove -y gcc-9
          sudo apt-get install -y gcc-10
          echo "CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_LINKER=gcc-10" >> "$GITHUB_ENV"
          echo "CC=gcc-10" >> "$GITHUB_ENV"
          # alsa_backend,rodio_backend and base deps
          sudo apt-get install -y libasound2-dev libssl-dev
          # dbus_mpris
          sudo apt-get install -y libdbus-1-dev
          # pulseaudio_backend
          sudo apt-get install -y libpulse-dev
          # portaudio_backend
          sudo apt-get install -y portaudio19-dev
      - name: Determine cargo args
        run: |
          features="--no-default-features --features ${{ matrix.dbus }},${{ matrix.audio_backends }}"
          echo CARGO_ARGS="--locked --release $features" | tee -a "$GITHUB_ENV"
      - name: Determine target triple
        id: target_triple
        shell: bash
        run: |
          # Map OS/arch to Rust target target_triple
          if [ "${{ matrix.target }}" != "" ]; then
            # Use the cross-compilation target if specified
            TARGET_TRIPLE="${{ matrix.target }}"
          elif [ "${{ matrix.os }}" = "linux" ] && [ "${{ matrix.arch }}" = "x86_64" ]; then
            TARGET_TRIPLE="x86_64-unknown-linux-gnu"
          elif [ "${{ matrix.os }}" = "macos" ] && [ "${{ matrix.arch }}" = "x86_64" ]; then
            TARGET_TRIPLE="x86_64-apple-darwin"
          elif [ "${{ matrix.os }}" = "macos" ] && [ "${{ matrix.arch }}" = "aarch64" ]; then
            TARGET_TRIPLE="aarch64-apple-darwin"
          else 
            echo "Unknown target: ${{ matrix.os }}-${{ matrix.arch }}"
            exit 1
          fi
          echo "target_triple=$TARGET_TRIPLE" >> $GITHUB_OUTPUT
          echo "Target triple: $TARGET_TRIPLE"
      - name: Build (using cargo)
        if: matrix.target == ''
        run: |
           cargo +${{ matrix.rust }} build $CARGO_ARGS
      - name: Build (using cross)
        if: matrix.target != ''
        uses: houseabsolute/actions-rust-cross@v1
        with:
          cross-version: baf457e # currently needed (check again if cross version > 0.2.5)
          command: build
          toolchain: ${{ matrix.rust }}
          target: ${{ matrix.target }}
          args: $CARGO_ARGS
      - name: Uploading artifacts (new naming)
        uses: actions/upload-artifact@v4
        with:
          name: spotifyd-${{ steps.target_triple.outputs.target_triple }}-${{ matrix.artifact_type }}
          path: target/${{ matrix.target }}/release/spotifyd
      - name: Uploading artifacts (legacy naming - deprecated)
        uses: actions/upload-artifact@v4
        with:
          name: spotifyd-${{ matrix.os }}-${{ matrix.arch }}-${{ matrix.artifact_type }}-legacy
          path: target/${{ matrix.target }}/release/spotifyd
  release: # only runs when a version tag is pushed
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Downloading artifacts # download all binaries
        uses: actions/download-artifact@v4
      - name: Packaging final binary
        shell: bash
        run: |
          for artifact_dir in ./*/
          do
            pushd $artifact_dir
            artifact_name=$(basename $artifact_dir)
            # Remove -legacy suffix for old naming format
            artifact_name=${artifact_name%-legacy}
            tar czvf $artifact_name.tar.gz spotifyd
            shasum -a 512 $artifact_name.tar.gz > $artifact_name.sha512
            popd
          done
      - name: Releasing assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            **/*.tar.gz
            **/*.sha512
          body: |
            ## Asset Naming Change
            Starting with this release, we're transitioning to Rust's standard target triple naming convention to support `cargo-binstall`.

            **New format:** `spotifyd-{target-triple}-{variant}.tar.gz`
            - Example: `spotifyd-x86_64-unknown-linux-gnu-full.tar.gz`

            **Legacy format** (deprecated, will be removed in next release): `spotifyd-{os}-{arch}-{variant}.tar.gz`
            - Example: `spotifyd-linux-x86_64-full-legacy.tar.gz`

          Both formats are available in this release for backwards compatibility.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
